From 797b78a5d60bfefc86efdc79bf3183a4a554efaf Mon Sep 17 00:00:00 2001
From: yingsu00 <yingsu00@outlook.com>
Date: Tue, 31 Jan 2023 10:52:21 +0200
Subject: [PATCH] Expose more CachingDirectoryLister metrics

---
 jmeter.log                                    | 25 ++++++++++++
 .../presto/hive/CachingDirectoryLister.java   | 39 ++++++++++++++++++-
 presto-main/etc/catalog/glue.properties       |  9 +++++
 3 files changed, 71 insertions(+), 2 deletions(-)
 create mode 100644 jmeter.log
 create mode 100644 presto-main/etc/catalog/glue.properties

diff --git a/jmeter.log b/jmeter.log
new file mode 100644
index 0000000000..85aa52f608
--- /dev/null
+++ b/jmeter.log
@@ -0,0 +1,25 @@
+2023-01-26 18:19:25,426 INFO o.a.j.u.JMeterUtils: Setting Locale to en_EN
+2023-01-26 18:19:25,450 INFO o.a.j.JMeter: Loading user properties from: /usr/local/Cellar/jmeter/5.5/libexec/bin/user.properties
+2023-01-26 18:19:25,451 INFO o.a.j.JMeter: Loading system properties from: /usr/local/Cellar/jmeter/5.5/libexec/bin/system.properties
+2023-01-26 18:19:25,456 INFO o.a.j.JMeter: Copyright (c) 1998-2022 The Apache Software Foundation
+2023-01-26 18:19:25,456 INFO o.a.j.JMeter: Version 5.5
+2023-01-26 18:19:25,456 INFO o.a.j.JMeter: java.version=19.0.2
+2023-01-26 18:19:25,456 INFO o.a.j.JMeter: java.vm.name=OpenJDK 64-Bit Server VM
+2023-01-26 18:19:25,456 INFO o.a.j.JMeter: os.name=Mac OS X
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: os.arch=x86_64
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: os.version=11.4
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: file.encoding=UTF-8
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: java.awt.headless=null
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: Max memory     =1073741824
+2023-01-26 18:19:25,457 INFO o.a.j.JMeter: Available Processors =16
+2023-01-26 18:19:25,466 INFO o.a.j.JMeter: Default Locale=English (EN)
+2023-01-26 18:19:25,466 INFO o.a.j.JMeter: JMeter  Locale=English (EN)
+2023-01-26 18:19:25,466 INFO o.a.j.JMeter: JMeterHome=/usr/local/Cellar/jmeter/5.5/libexec
+2023-01-26 18:19:25,466 INFO o.a.j.JMeter: user.dir  =/Users/yingsu/repo/ahana2/prestodb
+2023-01-26 18:19:25,466 INFO o.a.j.JMeter: PWD       =/Users/yingsu/repo/ahana2/prestodb
+2023-01-26 18:19:25,478 INFO o.a.j.JMeter: IP: 192.168.0.33 Name: Yings-MBP.hitronhub.home FullName: yings-mbp.hitronhub.home
+2023-01-26 18:19:25,487 INFO o.a.j.JMeter: Loaded icon properties from org/apache/jmeter/images/icon.properties
+2023-01-26 18:19:26,249 INFO o.a.j.JMeterGuiLauncher: Setting LAF to: com.github.weisj.darklaf.DarkLaf:com.github.weisj.darklaf.theme.DarculaTheme
+2023-01-26 18:19:28,809 INFO o.j.r.JARSourceHTTP: Requesting https://jmeter-plugins.org/repo/?installID=mac_os_x-9502ba75f58cb1a35f1eacfe46d37b0c-gui
+2023-01-26 18:19:30,004 INFO o.j.r.PluginManager: Plugins Status: [jpgc-plugins-manager=1.7, jmeter-core=5.5, jmeter-ftp=5.5, jmeter-http=5.5, jmeter-jdbc=5.5, jmeter-jms=5.5, jmeter-junit=5.5, jmeter-java=5.5, jmeter-ldap=5.5, jmeter-mail=5.5, jmeter-mongodb=5.5, jmeter-native=5.5, jmeter-tcp=5.5, jmeter-components=5.5]
+2023-01-26 18:19:30,004 INFO o.j.r.PluginManagerMenuItem: Plugins Manager has upgrades: [jpgc-plugins-manager]
diff --git a/presto-hive/src/main/java/com/facebook/presto/hive/CachingDirectoryLister.java b/presto-hive/src/main/java/com/facebook/presto/hive/CachingDirectoryLister.java
index 49610048a2..cdf8b7b8d8 100644
--- a/presto-hive/src/main/java/com/facebook/presto/hive/CachingDirectoryLister.java
+++ b/presto-hive/src/main/java/com/facebook/presto/hive/CachingDirectoryLister.java
@@ -42,11 +42,10 @@ import static java.util.Objects.requireNonNull;
 public class CachingDirectoryLister
         implements DirectoryLister
 {
+    protected final DirectoryLister delegate;
     private final Cache<Path, List<HiveFileInfo>> cache;
     private final CachedTableChecker cachedTableChecker;
 
-    protected final DirectoryLister delegate;
-
     @Inject
     public CachingDirectoryLister(@ForCachingDirectoryLister DirectoryLister delegate, HiveClientConfig hiveClientConfig)
     {
@@ -155,6 +154,42 @@ public class CachingDirectoryLister
         return cache.stats().requestCount();
     }
 
+    @Managed
+    public long getLoadCount()
+    {
+        return cache.stats().loadCount();
+    }
+
+    @Managed
+    public long getLoadSuccessCount()
+    {
+        return cache.stats().loadSuccessCount();
+    }
+
+    @Managed
+    public long getTLoadTime()
+    {
+        return cache.stats().totalLoadTime();
+    }
+
+    @Managed
+    public double getAverageLoadPenalty()
+    {
+        return cache.stats().averageLoadPenalty();
+    }
+
+    @Managed
+    public long getLoadExceptionCount()
+    {
+        return cache.stats().loadExceptionCount();
+    }
+
+    @Managed
+    public double getEvictionCount()
+    {
+        return cache.stats().evictionCount();
+    }
+
     private static class CachedTableChecker
     {
         private final Set<SchemaTableName> cachedTableNames;
diff --git a/presto-main/etc/catalog/glue.properties b/presto-main/etc/catalog/glue.properties
new file mode 100644
index 0000000000..eec2d547b8
--- /dev/null
+++ b/presto-main/etc/catalog/glue.properties
@@ -0,0 +1,9 @@
+connector.name=hive-hadoop2
+hive.metastore=glue
+hive.metastore.glue.region=us-east-1
+hive.metastore.glue.iam-role=arn:aws:iam::299095523242:role/ahana-glue-full-role
+hive.s3.iam-role=arn:aws:iam::299095523242:role/ahana-glue-s3-full-role
+#hive.metastore.glue.column-statistics-enabled=true
+hive.allow-drop-table=true
+hive.non-managed-table-writes-enabled=true
+hive.max-partitions-per-writers=5000
\ No newline at end of file
-- 
2.30.1 (Apple Git-130)

